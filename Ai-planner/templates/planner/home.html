{% extends "planner/base.html" %}
{% block title %}Dashboard | AI Habit Tracker{% endblock %}

{% block content %}

<h1 class="page-title">Dashboard</h1>

<div class="columns">

  <!-- ===================== COLUMN 1: SCORE + TODAY HABITS ===================== -->
  <div class="column">
    <h2 class="column-title">Todayâ€™s Overview</h2>

    <!-- 1ï¸âƒ£ AI Habit Score Card -->
    <div class="card card-main">
      <div class="card-header">
        <span>AI Habit Score</span>
        <i class="fas fa-brain"></i>
      </div>
      <div class="card-body">
        <div class="badge-row">
          <span class="pill pill-blue">Today: {{ stats.today_score }}%</span>
          <span class="pill pill-purple">7-Day Avg: {{ stats.weekly_score }}%</span>
          <span class="pill pill-orange">Best Streak: {{ stats.best_streak }}d</span>
        </div>

        <p class="card-text">
          Your score is based on how many habits you completed today, how consistent
          you've been this week, and your best streak so far.
        </p>
      </div>
    </div>

    <!-- 2ï¸âƒ£ Current Streak Card -->
    <div class="card">
      <div class="card-header">
        <span>Current Streak</span>
        <i class="fas fa-fire"></i>
      </div>
      <p class="card-text" style="font-size:18px;font-weight:600;">
        ðŸ”¥ {{ stats.current_streak }} day{% if stats.current_streak != 1 %}s{% endif %}
      </p>
      <p class="card-text">
        Total Habits: <strong>{{ stats.total_habits }}</strong> â€¢
        Done Today: <strong>{{ stats.done_today }}</strong>
      </p>
    </div>

    <!-- TODAY'S HABITS (Dynamic) -->
    <h2 class="column-title" style="margin-top:20px;">Today's Habits</h2>

    {% if habit_data %}
      {% for item in habit_data %}
      <div class="card habit-card" style="margin-top:12px;">
        <div class="card-header">
          <span>{{ item.habit.name }}</span>

          <!-- Delete Habit -->
          <a href="{% url 'delete_habit' item.habit.id %}"
             onclick="return confirm('Delete this habit?');">
            <i class="fas fa-trash"></i>
          </a>
        </div>

        <!-- Toggle Done / Not Done -->
        <form method="post" action="{% url 'toggle_habit_today' item.habit.id %}">
          {% csrf_token %}
          <div class="progress-wrapper" style="margin-top:8px; gap:10px;">
            <span>Status:</span>

            {% if item.done_today %}
              <span class="pill pill-blue">Done</span>
            {% else %}
              <span class="chip chip-orange">Not Done</span>
            {% endif %}

            <button type="submit"
                    style="margin-left:auto;padding:6px 10px;border-radius:8px;
                           border:none;background:#101231;color:white;font-size:12px;cursor:pointer;">
              Toggle
            </button>
          </div>
        </form>
      </div>
      {% endfor %}
    {% else %}
      <p style="margin-top:10px;">No habits added yet. Go to the Habits page and create one.</p>
    {% endif %}
  </div>

  <!-- ===================== COLUMN 2: 7-DAY TREND + LOG VOLUME ===================== -->
  <div class="column">
    <h2 class="column-title">7-Day Trend</h2>

    <!-- 3ï¸âƒ£ Completion Trend Chart -->
    <div class="card card-main">
      <div class="card-header">
        <span>Completion Trend (Last 7 Days)</span>
        <i class="fas fa-chart-line"></i>
      </div>

      <div class="widget">
        <div class="bar-row">
          {% for day in stats.trend %}
          <div class="bar-group">
            <div class="bar bar-blue"
                 style="height: {{ day.percent|default:0 }}px;"></div>
            <span>{{ day.label }}</span>
          </div>
          {% endfor %}
        </div>
        <p class="card-text" style="margin-top:10px;">
          Shows what % of your habits you completed each day.
        </p>
      </div>
    </div>

    <!-- 4ï¸âƒ£ Log Volume Chart -->
    <div class="card">
      <div class="card-header">
        <span>Log Volume (Last 7 Days)</span>
        <i class="fas fa-stream"></i>
      </div>

      <div class="widget">
        <div class="bar-row">
          {% for day in stats.volume %}
          {% with h=day.count|add:"10" %} {# base height so tiny values still visible #}
          <div class="bar-group">
            <div class="bar bar-purple" style="height: {{ h }}px;"></div>
            <span>{{ day.label }}</span>
          </div>
          {% endwith %}
          {% endfor %}
        </div>
        <p class="card-text" style="margin-top:10px;">
          Raw habit check-ins per day (done + missed). Taller bar = more tracking activity.
        </p>
      </div>
    </div>
  </div>

  <!-- ===================== COLUMN 3: CONSISTENCY + LEADERBOARD ===================== -->
  <div class="column">
    <h2 class="column-title">Consistency & Habits</h2>

    <!-- 5ï¸âƒ£ Consistency Heat Row (Last 7 Days) -->
    <div class="card card-main">
      <div class="card-header">
        <span>Consistency Heat (7 Days)</span>
        <i class="fas fa-temperature-high"></i>
      </div>

      <div class="chip-row" style="margin-top:8px; flex-wrap:wrap;">
        {% for day in stats.trend %}
          {% if day.percent >= 80 %}
            <span class="chip chip-green">{{ day.label }} â€¢ {{ day.percent }}%</span>
          {% elif day.percent >= 40 %}
            <span class="chip chip-orange">{{ day.label }} â€¢ {{ day.percent }}%</span>
          {% else %}
            <span class="chip" style="background:rgba(255,255,255,0.05);">
              {{ day.label }} â€¢ {{ day.percent }}%
            </span>
          {% endif %}
        {% endfor %}
      </div>

      <p class="card-text">
        Green = great days, orange = okay, grey = low-activity days. Aim for a green week ðŸŒ±
      </p>
    </div>

    <!-- Habit Leaderboard -->
    <div class="card">
      <div class="card-header">
        <span>Habit Leaderboard (Last 14 Days)</span>
        <i class="fas fa-trophy"></i>
      </div>

      {% if stats.habit_leaderboard %}
        {% for row in stats.habit_leaderboard %}
        <div style="margin-bottom:10px;">
          <div style="font-size:13px; margin-bottom:4px;">
            {{ forloop.counter }}. {{ row.habit.name }}
            <span style="opacity:0.7;">â€“ {{ row.percent }}%</span>
          </div>
          <div class="progress-bar" style="height:8px;">
            <div class="progress-fill"
                 style="width: {{ row.percent }}%;"></div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="card-text">Not enough data yet. Start completing habits to see your leaderboard.</p>
      {% endif %}
    </div>
  </div>

  <!-- ===================== RIGHT PANEL (OPTIONAL SIDE WIDGETS) ===================== -->
  <div class="right-panel">
    <div class="widget">
      <h3>Quick Snapshot</h3>
      <div class="circle-row">
        <div class="circle-card">
          <div class="circle">{{ stats.today_score }}%</div>
          <span>Today</span>
        </div>
        <div class="circle-card">
          <div class="circle">{{ stats.weekly_score }}%</div>
          <span>7-Day Avg</span>
        </div>
        <div class="circle-card">
          <div class="circle">{{ stats.best_streak }}d</div>
          <span>Best Streak</span>
        </div>
      </div>
    </div>

    <div class="widget">
      <h3>Completion Today</h3>
      {% if stats.total_habits > 0 %}
      <p class="card-text">
        {{ stats.done_today }} / {{ stats.total_habits }} habits done
      </p>
      <div class="progress-bar" style="height:10px;margin-top:8px;">
        <div class="progress-fill"
             style="width: {{ stats.today_score }}%;"></div>
      </div>
      {% else %}
      <p class="card-text">Create your first habit to start tracking.</p>
      {% endif %}
    </div>
  </div>

</div>

{% endblock %}
